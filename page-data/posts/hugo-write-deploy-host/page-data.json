{"componentChunkName":"component---src-templates-post-template-js","path":"/posts/hugo-write-deploy-host","result":{"data":{"markdownRemark":{"id":"f0809856-8910-5708-a716-8b438903be3b","html":"<p>In this port I’ll show you how I write my posts, deploy them to the server, process them with <a href=\"https://gohugo.io\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Hugo</a> and host them on my <a href=\"https://m.do.co/c/875cd23a5c97\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">DigitalOcean</a> server.</p>\n<p>I wanted this process to be as easy and quick as possible, with as few extra softwares and services as possible. There are a lot of solutions out there like Wercker but I didn’t want more things in my way.</p>\n<h1 id=\"writing\" style=\"position:relative;\"><a href=\"#writing\" aria-label=\"writing permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Writing</h1>\n<h2 id=\"local\" style=\"position:relative;\"><a href=\"#local\" aria-label=\"local permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Local</h2>\n<p>I write the posts from IntelliJ IDEA, which is my IDE of choice. Screw Sublime, Atom and all the rest! It’s quite heavier but is worth it. You get spell checking, quite good live previews with the Multimarkdown plugin (shame the embedded HTML doesn’t render), git integration, and in general a powerful IDE.</p>\n<p>Just to be clear I like Sublime and Atom, but every time I use them there is something wrong. Right now the terminal in Atom doesn’t work for me. There is an open issue for this but in the meantime you get a blinking unmovable cursor staring at you.</p>\n<p>I feel that, since Hugo is quite new, the tools haven’t caught up with its popularity yet. Intellij is flexible enough to allow you to have shortcuts <a href=\"https://www.jetbrains.com/help/idea/2016.1/live-templates.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">live templates</a> for your shortcodes. E.g.:  </p>\n<div class=\"gatsby-highlight\" data-language=\"xml\"><pre class=\"language-xml\"><code class=\"language-xml\">  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>template</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>.shortcode<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>{{<span class=\"token entity named-entity\" title=\"&lt;\">&amp;lt;</span> $SHORTCODE$ <span class=\"token entity named-entity\" title=\"&gt;\">&amp;gt;</span>}}<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">description</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>A Hugo shortcode<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">toReformat</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>false<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">toShortenFQNames</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>true<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>variable</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>SHORTCODE<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">expression</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span><span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">defaultValue</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span><span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">alwaysStopAt</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>true<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>context</span><span class=\"token punctuation\">></span></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>option</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>OTHER<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>true<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>context</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>template</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>This allows me to type <code class=\"language-text\">.s</code>, press enter (if the live template <code class=\"language-text\">.shortcode</code> is selected), type the name of the shortcode and its parameters and press enter to keep typing without having to type too many symbols or having to move your cursor.</p>\n<p>I keep switching between IntelliJ and the localhost page on my browser, where my hugo server is showing how the end result will be (just launch “hugo server” from the root folder). If you have the page open you don’t even need to refresh it thanks to Hugo’s live reload feature (and don’t even have to save the file since IntelliJ does it when it loses focus). This is very quick to do, which is particularly nice when you want to make final tweaks to make sure your post will display as you want.</p>\n<h2 id=\"online\" style=\"position:relative;\"><a href=\"#online\" aria-label=\"online permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Online</h2>\n<p>If you are using Github and want to write from your browser, or you are not at home, you can use <a href=\"https://prose.io\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">prose.io</a>. It’s a software developed for Jekyll, but works just fine with Hugo. You get some nice shortcuts to format your text with markdown in case you are not too familiar with it. It also allows you to upload images which are committed to your repo immediately. I don’t find it quite as powerful as IntelliJ but it’s a nice option.</p>\n<p>You can have a look at <a href=\"https://github.com/Draga/go-web/blob/master/_prose.yml\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">my prose configuration</a> to get you started. It’s important to know that prose.io can only generate content with yaml metadata. You will have to configure Hugo to do the same by adding <code class=\"language-text\">MetaDataFormat: yaml</code>.</p>\n<p>I’ve looked at many more free online content editor:</p>\n<ul>\n<li><a href=\"http://sofish.github.io/pen/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">sofish</a></li>\n<li><a href=\"http://www.webhook.com/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">webhook</a></li>\n<li><a href=\"https://www.contentful.com\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">contentful</a></li>\n<li><a href=\"https://prismic.io/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">prismic</a></li>\n<li><a href=\"https://stackedit.io\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">stackedit</a></li>\n<li><a href=\"http://dillinger.io/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">dillinger</a></li>\n</ul>\n<p>I found them actually extremely good…just not very compatible with Hugo.</p>\n<p>Unfortunately I couldn’t find any online resource to write and preview Hugo content, so editing content locally and preview it with Hugo server is still the best option for me. I reckon you could host a test environment to preview your draft, deploying with a different branch, by adding <code class=\"language-text\">-buildDrafts</code> to your <code class=\"language-text\">hugo</code> or <code class=\"language-text\">hugo server</code> commands.</p>\n<p>Hopefully some tool that works perfectly with Hugo will come out soon. Spf13, the creator of Hugo, <a href=\"https://discuss.gohugo.io/t/web-based-editor/155/41\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">is thinking about creating one</a>.</p>\n<h1 id=\"deployment\" style=\"position:relative;\"><a href=\"#deployment\" aria-label=\"deployment permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Deployment</h1>\n<p>I can deploy my website in 2 ways:</p>\n<ul>\n<li>Push you branch to the repo on the server.</li>\n<li>Push the master branch to the main repo. In my case this is on Github but can work with pretty much anything else.</li>\n</ul>\n<p>These both trigger a small script which I’ve adapted from <a href=\"https://www.digitalocean.com/community/tutorials/how-to-deploy-a-hugo-site-to-production-with-git-hooks-on-ubuntu-14-04\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">this tutorial on Digitalocean</a>.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#!/bin/bash</span>\n\n<span class=\"token comment\"># Better be specific rather than using $HOME because it wouldn't work with all users.</span>\n<span class=\"token assign-left variable\">GIT_REPO</span><span class=\"token operator\">=</span>/home/draga/go-web\n<span class=\"token assign-left variable\">WORKING_DIRECTORY</span><span class=\"token operator\">=</span><span class=\"token variable\">$GIT_REPO</span>/public\n<span class=\"token assign-left variable\">PUBLIC_WWW</span><span class=\"token operator\">=</span>/home/draga/public_html\n<span class=\"token assign-left variable\">BACKUP_WWW</span><span class=\"token operator\">=</span>/home/draga/backup_html\n\n<span class=\"token builtin class-name\">set</span> -e\n\n<span class=\"token comment\"># Clean working dir.</span>\n<span class=\"token function\">rm</span> -rf <span class=\"token variable\">$WORKING_DIRECTORY</span>\n<span class=\"token comment\"># Backup current website. Use -z if moving across network to save bandwidth.</span>\n<span class=\"token function\">rsync</span> -aq <span class=\"token variable\">$PUBLIC_WWW</span>/ <span class=\"token variable\">$BACKUP_WWW</span>\n<span class=\"token comment\"># Restore backup if an error occurs from now on.</span>\n<span class=\"token builtin class-name\">trap</span> <span class=\"token string\">\"echo 'A problem occurred.  Reverting to backup.'; rsync -aq --del <span class=\"token variable\">$BACKUP_WWW</span>/ <span class=\"token variable\">$PUBLIC_WWW</span>; rm -rf <span class=\"token variable\">$WORKING_DIRECTORY</span>\"</span> EXIT\n\n<span class=\"token comment\"># fetch repo to make sure it's up to date if working with remote webhook.</span>\n<span class=\"token builtin class-name\">cd</span> <span class=\"token variable\">$GIT_REPO</span>\n<span class=\"token function\">git</span> fetch\n<span class=\"token function\">git</span> checkout origin/master\n<span class=\"token comment\"># Build the website. GO HUGO!</span>\n/usr/bin/hugo -s <span class=\"token variable\">$GIT_REPO</span> -d <span class=\"token variable\">$WORKING_DIRECTORY</span>\n<span class=\"token comment\"># Mirror the output of Hugo to the directory where the website is hosted.</span>\n<span class=\"token comment\"># Use -c to copy only files that have changed to avoid messing with webhost caches.</span>\n<span class=\"token comment\"># Use -z if moving across network to save bandwidth.</span>\n<span class=\"token function\">rsync</span> -aqc --delete <span class=\"token variable\">$WORKING_DIRECTORY</span>/ <span class=\"token variable\">$PUBLIC_WWW</span>\n<span class=\"token comment\"># Ask Google webmaster tools to parse your sitemap.</span>\n<span class=\"token function\">curl</span> https://google.com/webmasters/sitemaps/ping?sitemap<span class=\"token operator\">=</span>https://stefano.chiodino.uk/sitemap.xml\n<span class=\"token function\">curl</span> https://www.bing.com/ping?sitemap<span class=\"token operator\">=</span>https%3A%2F%2Fstefano.chiodino.uk/sitemap.xml\n<span class=\"token comment\"># Disable trap.</span>\n<span class=\"token builtin class-name\">trap</span> - EXIT</code></pre></div>\n<p>I used the method described in the tutorial above for a while, but it bothered me to push twice since I had to type the password for my ssh key (I’ve disabled the password access to the server and can now only be accessed with the key). Also what if I wasn’t home or wanted to use prose.io?</p>\n<p>Solution: git(hub) webhooks!</p>\n<p>Thanks to <a href=\"https://github.com/adnanh/webhook\" target=\"_blank\">github.com/adnanh/webhook</a>, little software written in go, you can have you server listen on a port and execute a script when invoked.</p>\n<p>I currently have it connecting in https, with a secret key, and executing the script when the master branch is pushed.</p>\n<p>Now I can even use Github itself to edit my posts. Pretty neat!</p>\n<h1 id=\"hosting\" style=\"position:relative;\"><a href=\"#hosting\" aria-label=\"hosting permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Hosting</h1>\n<p>Now this was the <del>long</del> fun part. I wanted it all so it took a lot of learning, hence the fun.</p>\n<p>I heard of nginx a lot and some research showed that it seems to be the go-to solution. Here are some, more performance related, details of how it performs for me: <a href=\"/posts/server-load-test\">server load test</a>.</p>\n<p>I’ve then enabled the pagespeed module which is very complex and heavy, but definitively worth it!\nThe website now scores <a href=\"https://developers.google.com/speed/pagespeed/insights/?url=https%3A%2F%2Fstefano.chiodino.uk%2F\" target=\"_blank\">100/100 in Google PageSpeed</a>, both in mobile and desktop!</p>\n<p>I score 99/100 in <a href=\"https://gtmetrix.com/reports/stefano.chiodino.uk/FsGkxV4j\" target=\"_blank\">GTmetrix</a> just because there is a bug in the pagespeed module (<a href=\"https://github.com/pagespeed/ngx_pagespeed/issues/1064\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">1064</a>) and the very header is added twice, and for some reason GTmetrix seems to think that is not there…? Or maybe is because pagespeed seems to add it on subsequent reloads. Another small penalty is for the G analytics code being cached for just 2 hours, it’s out of my control and don’t think is worth self hosting it.</p>\n<p>YSlow seems to be mostly concerned of the lack of CDN.</p>\n<p>You can find all the scripts that I’ve used to set up my server on <a href=\"https://github.com/Draga/serverScripts\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">github</a>. They are ordered in the same way they are in the filesystem, so you should get the idea. There is a script to install nginx with the brotli and pagespeed module, directives to use webhook as a service, the entire nginx configuration, etc.</p>","fields":{"slug":"/posts/hugo-write-deploy-host","tagSlugs":["/tag/hugo/","/tag/git/","/tag/github/","/tag/deployment/","/tag/nginx/","/tag/pagespeed/"],"categorySlug":"/category/programming/"},"frontmatter":{"date":"2016-05-21T20:51:00.000Z","tags":["Hugo","Git","Github","Deployment","Nginx","Pagespeed"],"title":"Hugo: write, deploy, host","category":"Programming"}}},"pageContext":{"slug":"/posts/hugo-write-deploy-host"}},"staticQueryHashes":["1796801393","251939775","401334301"]}